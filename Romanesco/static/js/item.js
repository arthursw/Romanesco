// Generated by CoffeeScript 1.7.1
(function() {
  var RContent, RItem,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  RItem = (function() {
    RItem.indexToName = {
      0: 'bottomLeft',
      1: 'left',
      2: 'topLeft',
      3: 'top',
      4: 'topRight',
      5: 'right',
      6: 'bottomRight',
      7: 'bottom'
    };

    RItem.oppositeName = {
      'top': 'bottom',
      'bottom': 'top',
      'left': 'right',
      'right': 'left',
      'topLeft': 'bottomRight',
      'topRight': 'bottomLeft',
      'bottomRight': 'topLeft',
      'bottomLeft': 'topRight'
    };

    RItem.cornerNames = ['topLeft', 'topRight', 'bottomRight', 'bottomLeft'];

    RItem.valueFromName = function(point, name) {
      switch (name) {
        case 'left':
        case 'right':
          return point.x;
        case 'top':
        case 'bottom':
          return point.y;
        default:
          return point;
      }
    };

    RItem.hitOptions = {
      segments: true,
      stroke: true,
      fill: true,
      selected: true,
      tolerance: 5
    };

    RItem.parameters = function() {
      var parameters;
      parameters = {
        'General': {
          align: g.parameters.align,
          distribute: g.parameters.distribute,
          "delete": g.parameters["delete"]
        },
        'Style': {
          strokeWidth: g.parameters.strokeWidth,
          strokeColor: g.parameters.strokeColor,
          fillColor: g.parameters.fillColor
        }
      };
      return parameters;
    };

    function RItem(data, pk) {
      var controller, folder, name, _base, _i, _len, _name, _ref, _ref1, _ref2;
      this.data = data;
      this.pk = pk;
      this.endAction = __bind(this.endAction, this);
      if (this.pk != null) {
        this.setPK(this.pk, false);
      } else {
        this.id = ((_ref = this.data) != null ? _ref.id : void 0) != null ? this.data.id : Math.random();
        g.items[this.id] = this;
      }
      if (this.data == null) {
        this.data = new Object();
      }
      _ref1 = g.gui.__folders;
      for (name in _ref1) {
        folder = _ref1[name];
        if (name === 'General') {
          continue;
        }
        _ref2 = folder.__controllers;
        for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
          controller = _ref2[_i];
          if ((_base = this.data)[_name = controller.property] == null) {
            _base[_name] = controller.rValue();
          }
        }
      }
      if (this.rectangle == null) {
        this.rectangle = null;
      }
      this.selectionState = null;
      this.selectionRectangle = null;
      this.group = new Group();
      this.group.name = "group";
      this.group.controller = this;
      return;
    }

    RItem.prototype.changeParameterCommand = function(name, value) {
      this.deferredAction(ChangeParameterCommand, name, value);
    };

    RItem.prototype.changeParameter = function(name, value, updateGUI, update) {
      this.data[name] = value;
      this.changed = name;
      if (update) {
        this.update(name);
      }
      if (updateGUI) {
        g.setControllerValueByName(name, value, this);
      }
    };

    RItem.prototype.prepareHitTest = function(fullySelected, strokeWidth) {
      if (fullySelected == null) {
        fullySelected = true;
      }
    };

    RItem.prototype.finishHitTest = function(fullySelected) {
      if (fullySelected == null) {
        fullySelected = true;
      }
    };

    RItem.prototype.hitTest = function(point, hitOptions) {
      return this.selectionRectangle.hitTest(point);
    };

    RItem.prototype.performHitTest = function(point, hitOptions, fullySelected) {
      var hitResult;
      if (fullySelected == null) {
        fullySelected = true;
      }
      this.prepareHitTest(fullySelected, 1);
      hitResult = this.hitTest(point, hitOptions);
      this.finishHitTest(fullySelected);
      return hitResult;
    };

    RItem.prototype.initializeSelection = function(event, hitResult) {
      if ((hitResult != null ? hitResult.type : void 0) === 'segment') {
        if (hitResult.item === this.selectionRectangle) {
          this.selectionState = {
            resize: {
              index: hitResult.segment.index
            }
          };
        }
      }
    };

    RItem.prototype.beginSelect = function(event) {
      var hitResult;
      this.selectionState = {
        move: true
      };
      if (!this.isSelected()) {
        g.commandManager.add(new SelectCommand([this]), true);
      } else {
        hitResult = this.performHitTest(event.point, this.constructor.hitOptions);
        if (hitResult != null) {
          this.initializeSelection(event, hitResult);
        }
      }
      if (this.selectionState.move != null) {
        this.beginAction(new MoveCommand(this));
      } else if (this.selectionState.resize != null) {
        this.beginAction(new ResizeCommand(this));
      }
    };

    RItem.prototype.updateSelect = function(event) {
      this.updateAction(event);
    };

    RItem.prototype.endSelect = function(event) {
      this.endAction();
    };

    RItem.prototype.beginAction = function(command) {
      if (this.currentCommand) {
        this.endAction();
        clearTimeout(g.updateTimeout['addCurrentCommand-' + (this.id || this.pk)]);
      }
      this.currentCommand = command;
    };

    RItem.prototype.updateAction = function() {
      this.currentCommand.update.apply(this.currentCommand, arguments);
    };

    RItem.prototype.endAction = function() {
      var commandChanged, positionIsValid;
      positionIsValid = g.validatePosition(this);
      commandChanged = this.currentCommand.end(positionIsValid);
      if (positionIsValid) {
        if (commandChanged) {
          g.commandManager.add(this.currentCommand);
        }
      } else {
        this.currentCommand.undo();
      }
      this.currentCommand = null;
    };

    RItem.prototype.deferredAction = function() {
      var ActionCommand, args;
      ActionCommand = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      if (!ActionCommand.prototype.isPrototypeOf(this.currentCommand)) {
        this.beginAction(new ActionCommand(this, args));
      }
      this.updateAction.apply(this, args);
      g.deferredExecution(this.endAction, 'addCurrentCommand-' + (this.id || this.pk));
    };

    RItem.prototype.doAction = function(ActionCommand, args) {
      this.beginAction(new ActionCommand(this));
      this.updateAction.apply(this, args);
      this.endAction();
    };

    RItem.prototype.createSelectionRectangle = function(bounds) {
      this.selectionRectangle.insert(1, new Point(bounds.left, bounds.center.y));
      this.selectionRectangle.insert(3, new Point(bounds.center.x, bounds.top));
      this.selectionRectangle.insert(5, new Point(bounds.right, bounds.center.y));
      this.selectionRectangle.insert(7, new Point(bounds.center.x, bounds.bottom));
    };

    RItem.prototype.updateSelectionRectangle = function() {
      var bounds, _ref;
      bounds = this.rectangle.clone().expand(10);
      if ((_ref = this.selectionRectangle) != null) {
        _ref.remove();
      }
      this.selectionRectangle = new Path.Rectangle(bounds);
      this.group.addChild(this.selectionRectangle);
      this.selectionRectangle.name = "selection rectangle";
      this.selectionRectangle.pivot = bounds.center;
      this.createSelectionRectangle(bounds);
      this.selectionRectangle.selected = true;
      this.selectionRectangle.controller = this;
    };

    RItem.prototype.setRectangle = function(rectangle, update) {
      if (update == null) {
        update = false;
      }
      this.rectangle = rectangle;
      this.updateSelectionRectangle();
      if (update) {
        this.update('rectangle');
      }
    };

    RItem.prototype.updateSetRectangle = function(event) {
      var center, delta, dx, dy, index, name, rectangle, rotation, x, y;
      rotation = this.rotation || 0;
      rectangle = this.rectangle.clone();
      delta = event.point.subtract(this.rectangle.center);
      x = new Point(1, 0);
      x.angle += rotation;
      dx = x.dot(delta);
      y = new Point(0, 1);
      y.angle += rotation;
      dy = y.dot(delta);
      index = this.selectionState.resize.index;
      name = this.constructor.indexToName[index];
      if (!event.modifiers.shift && __indexOf.call(this.constructor.cornerNames, name) >= 0 && rectangle.width > 0 && rectangle.height > 0) {
        if (Math.abs(dx / rectangle.width) > Math.abs(dy / rectangle.height)) {
          dx = g.sign(dx) * Math.abs(rectangle.width * dy / rectangle.height);
        } else {
          dy = g.sign(dy) * Math.abs(rectangle.height * dx / rectangle.width);
        }
      }
      center = rectangle.center.clone();
      rectangle[name] = this.constructor.valueFromName(center.add(dx, dy), name);
      if (!g.specialKey(event)) {
        rectangle[this.constructor.oppositeName[name]] = this.constructor.valueFromName(center.subtract(dx, dy), name);
      } else {
        rectangle.center = center.add(rectangle.center.subtract(center).rotate(rotation));
      }
      if (rectangle.width < 0) {
        rectangle.width = Math.abs(rectangle.width);
        rectangle.center.x = center.x;
      }
      if (rectangle.height < 0) {
        rectangle.height = Math.abs(rectangle.height);
        rectangle.center.y = center.y;
      }
      this.setRectangle(rectangle);
      g.highlightValidity(this);
    };

    RItem.prototype.endSetRectangle = function() {
      this.update('rectangle');
    };

    RItem.prototype.moveTo = function(position, update) {
      var delta;
      delta = position.subtract(this.rectangle.center);
      this.rectangle.center = position;
      this.group.translate(delta);
      if (update) {
        this.update('position');
      }
    };

    RItem.prototype.moveBy = function(delta, update) {
      this.moveTo(this.rectangle.center.add(delta), update);
    };

    RItem.prototype.updateMoveBy = function(event) {
      this.moveBy(event.delta);
      g.highlightValidity(this);
    };

    RItem.prototype.endMoveBy = function() {
      this.update('position');
    };

    RItem.prototype.moveToCommand = function(position) {
      g.commandManager.add(new MoveCommand(this, position), true);
    };

    RItem.prototype.moveByCommand = function(delta) {
      this.moveToCommand(this.rectangle.center.add(delta), true);
    };

    RItem.prototype.getData = function() {
      var data;
      data = jQuery.extend({}, this.data);
      data.rectangle = this.rectangle.toJSON();
      data.rotation = this.rotation;
      return data;
    };

    RItem.prototype.getStringifiedData = function() {
      return JSON.stringify(this.getData());
    };

    RItem.prototype.getBounds = function() {
      return this.rectangle;
    };

    RItem.prototype.highlight = function() {
      var _ref;
      this.highlightRectangle = new Path.Rectangle(this.getBounds());
      this.highlightRectangle.strokeColor = g.selectionBlue;
      this.highlightRectangle.dashArray = [4, 10];
      if ((_ref = this.group) != null) {
        _ref.addChild(this.highlightRectangle);
      }
      this.highlightRectangle.bringToFront();
    };

    RItem.prototype.unhighlight = function() {
      if (this.highlightRectangle == null) {
        return;
      }
      this.highlightRectangle.remove();
      this.highlightRectangle = null;
    };

    RItem.prototype.setPK = function(pk) {
      this.pk = pk;
      g.items[pk] = this;
      delete g.items[this.id];
    };

    RItem.prototype.isSelected = function() {
      return this.selectionRectangle != null;
    };

    RItem.prototype.select = function(updateOptions, updateSelectionRectangle) {
      var _ref;
      if (updateOptions == null) {
        updateOptions = true;
      }
      if (updateSelectionRectangle == null) {
        updateSelectionRectangle = true;
      }
      if (this.selectionRectangle != null) {
        return false;
      }
      g.previouslySelectedItems = g.selectedItems.slice();
      if ((_ref = this.lock) != null) {
        _ref.deselect();
      }
      this.selectionState = {
        move: true
      };
      if (updateOptions) {
        g.updateParameters({
          tool: this.constructor,
          item: this
        }, true);
      }
      g.s = this;
      if (updateSelectionRectangle) {
        this.updateSelectionRectangle(true);
        g.selectedItems.push(this);
      }
      return true;
    };

    RItem.prototype.deselect = function(updatePreviouslySelectedItems) {
      var _ref;
      if (updatePreviouslySelectedItems == null) {
        updatePreviouslySelectedItems = true;
      }
      if (this.selectionRectangle == null) {
        return false;
      }
      if (updatePreviouslySelectedItems) {
        g.previouslySelectedItems = g.selectedItems.slice();
      }
      if ((_ref = this.selectionRectangle) != null) {
        _ref.remove();
      }
      this.selectionRectangle = null;
      g.selectedItems.remove(this);
      return true;
    };

    RItem.prototype.remove = function() {
      var _ref;
      this.deselect();
      this.group.remove();
      this.group = null;
      if ((_ref = this.highlightRectangle) != null) {
        _ref.remove();
      }
      if (this.pk != null) {
        delete g.items[this.pk];
      } else {
        delete g.items[this.id];
      }
    };

    RItem.prototype.deleteCommand = function() {
      g.commandManager.add(new DeleteCommand(this), true);
    };

    return RItem;

  })();

  this.RItem = RItem;

  RContent = (function(_super) {
    __extends(RContent, _super);

    RContent.indexToName = {
      0: 'bottomLeft',
      1: 'left',
      2: 'topLeft',
      3: 'top',
      4: 'rotation-handle',
      5: 'top',
      6: 'topRight',
      7: 'right',
      8: 'bottomRight',
      9: 'bottom'
    };

    RContent.parameters = function() {
      var parameters;
      parameters = RContent.__super__.constructor.parameters.call(this);
      parameters['General'].duplicate = g.parameters.duplicate;
      return parameters;
    };

    function RContent(data, pk, date, itemListJ, sortedItems) {
      this.data = data;
      this.pk = pk;
      this.date = date;
      this.sortedItems = sortedItems;
      RContent.__super__.constructor.call(this, this.data, this.pk);
      if (this.date == null) {
        this.date = Date.now();
      }
      this.rotation = this.data.rotation || 0;
      this.liJ = $("<li>");
      this.setZindexLabel();
      this.liJ.attr("data-pk", this.pk);
      this.liJ.click((function(_this) {
        return function(event) {
          if (!event.shiftKey) {
            g.deselectAll();
          }
          _this.select();
        };
      })(this));
      this.liJ.mouseover((function(_this) {
        return function(event) {
          _this.highlight();
        };
      })(this));
      this.liJ.mouseout((function(_this) {
        return function(event) {
          _this.unhighlight();
        };
      })(this));
      this.liJ.rItem = this;
      itemListJ.prepend(this.liJ);
      $("#RItems .mCustomScrollbar").mCustomScrollbar("scrollTo", "bottom");
      this.updateZIndex();
      return;
    }

    RContent.prototype.addToParent = function() {
      var bounds, lock;
      bounds = this.getBounds();
      lock = RLock.getLockWhichContains(bounds);
      if ((lock != null) && lock.owner === g.me) {
        lock.addItem(this);
      } else {
        g.addItemToStage(this);
      }
    };

    RContent.prototype.setZindexLabel = function() {
      var dateLabel, zindexLabel;
      dateLabel = '' + this.date;
      dateLabel = dateLabel.substring(dateLabel.length - 7, dateLabel.length - 3);
      zindexLabel = this.constructor.rname;
      if (dateLabel.length > 0) {
        zindexLabel += ' - ' + dateLabel;
      }
      this.liJ.text(zindexLabel);
    };

    RContent.prototype.initializeSelection = function(event, hitResult) {
      RContent.__super__.initializeSelection.call(this, event, hitResult);
      if ((hitResult != null ? hitResult.type : void 0) === 'segment') {
        if (hitResult.item === this.selectionRectangle) {
          if (this.constructor.indexToName[hitResult.segment.index] === 'rotation-handle') {
            this.selectionState = {
              rotation: true
            };
          }
        }
      }
    };

    RContent.prototype.beginSelect = function(event) {
      RContent.__super__.beginSelect.call(this, event);
      if (this.selectionState.rotation != null) {
        this.beginAction(new RotationCommand(this));
      }
    };

    RContent.prototype.createSelectionRectangle = function(bounds) {
      this.selectionRectangle.insert(1, new Point(bounds.left, bounds.center.y));
      this.selectionRectangle.insert(3, new Point(bounds.center.x, bounds.top));
      this.selectionRectangle.insert(3, new Point(bounds.center.x, bounds.top - 25));
      this.selectionRectangle.insert(3, new Point(bounds.center.x, bounds.top));
      this.selectionRectangle.insert(7, new Point(bounds.right, bounds.center.y));
      this.selectionRectangle.insert(9, new Point(bounds.center.x, bounds.bottom));
    };

    RContent.prototype.updateSelectionRectangle = function() {
      RContent.__super__.updateSelectionRectangle.call(this);
      this.selectionRectangle.rotation = this.rotation;
    };

    RContent.prototype.setRotation = function(rotation, update) {
      var previousRotation;
      previousRotation = this.rotation;
      this.group.pivot = this.rectangle.center;
      this.rotation = rotation;
      this.group.rotate(rotation - previousRotation);
      if (update) {
        this.update('rotation');
      }
    };

    RContent.prototype.updateSetRotation = function(event) {
      var rotation;
      rotation = event.point.subtract(this.rectangle.center).angle + 90;
      this.setRotation(rotation);
      g.highlightValidity(this);
    };

    RContent.prototype.endSetRotation = function() {
      this.update('rotation');
    };

    RContent.prototype.getData = function() {
      var data;
      data = jQuery.extend({}, RContent.__super__.getData.call(this));
      data.rotation = this.rotation;
      return data;
    };

    RContent.prototype.getBounds = function() {
      if (this.rotation === 0) {
        return this.rectangle;
      }
      return g.getRotatedBounds(this.rectangle, this.rotation);
    };

    RContent.prototype.highlight = function() {
      var _ref;
      this.highlightRectangle = new Path.Rectangle(this.getBounds());
      this.highlightRectangle.strokeColor = g.selectionBlue;
      this.highlightRectangle.dashArray = [4, 10];
      if ((_ref = this.group) != null) {
        _ref.addChild(this.highlightRectangle);
      }
    };

    RContent.prototype.unhighlight = function() {
      if (this.highlightRectangle == null) {
        return;
      }
      this.highlightRectangle.remove();
      this.highlightRectangle = null;
    };

    RContent.prototype.updateZIndex = function() {
      var found, i, item, _i, _len, _ref;
      if (this.date == null) {
        return;
      }
      if (this.sortedItems.length === 0) {
        this.sortedItems.push(this);
        return;
      }
      found = false;
      _ref = this.sortedItems;
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        item = _ref[i];
        if (this.date < item.date) {
          this.insertBelow(item, i);
          found = true;
          break;
        }
      }
      if (!found) {
        this.insertAbove(this.sortedItems.last());
      }
    };

    RContent.prototype.insertAbove = function(item, index, update) {
      var nextDate, previousDate;
      if (index == null) {
        index = null;
      }
      if (update == null) {
        update = false;
      }
      this.group.insertAbove(item.group);
      if (!index) {
        this.sortedItems.remove(this);
        index = this.sortedItems.indexOf(item) + 1;
      }
      this.sortedItems.splice(index, 0, this);
      this.liJ.insertBefore(item.liJ);
      if (update) {
        if (this.sortedItems[index + 1] == null) {
          this.date = Date.now();
        } else {
          previousDate = this.sortedItems[index - 1].date;
          nextDate = this.sortedItems[index + 1].date;
          this.date = (previousDate + nextDate) / 2;
        }
        this.update('z-index');
      }
      this.setZindexLabel();
    };

    RContent.prototype.insertBelow = function(item, index, update) {
      var nextDate, previousDate;
      if (index == null) {
        index = null;
      }
      if (update == null) {
        update = false;
      }
      this.group.insertBelow(item.group);
      if (!index) {
        this.sortedItems.remove(this);
        index = this.sortedItems.indexOf(item);
      }
      this.sortedItems.splice(index, 0, this);
      this.liJ.insertAfter(item.liJ);
      if (update) {
        if (this.sortedItems[index - 1] == null) {
          this.date = this.sortedItems[index + 1].date - 1000;
        } else {
          previousDate = this.sortedItems[index - 1].date;
          nextDate = this.sortedItems[index + 1].date;
          this.date = (previousDate + nextDate) / 2;
        }
        this.update('z-index');
      }
      this.setZindexLabel();
    };

    RContent.prototype.setPK = function(pk) {
      var _ref;
      RContent.__super__.setPK.call(this, pk);
      if ((_ref = this.liJ) != null) {
        _ref.attr("data-pk", this.pk);
      }
    };

    RContent.prototype.select = function(updateOptions, updateSelectionRectangle) {
      if (updateOptions == null) {
        updateOptions = true;
      }
      if (updateSelectionRectangle == null) {
        updateSelectionRectangle = true;
      }
      if (!RContent.__super__.select.call(this, updateOptions, updateSelectionRectangle)) {
        return false;
      }
      this.liJ.addClass('selected');
      if (this.group.parent !== g.selectionLayer) {
        this.zindex = this.group.index;
      }
      g.selectionLayer.addChild(this.group);
      return true;
    };

    RContent.prototype.deselect = function() {
      if (!RContent.__super__.deselect.call(this)) {
        return false;
      }
      this.liJ.removeClass('selected');
      if (!this.lock) {
        g.mainLayer.insertChild(this.zindex, this.group);
      } else {
        this.lock.group.insertChild(this.zindex, this.group);
      }
      return true;
    };

    RContent.prototype.remove = function() {
      var _ref, _ref1;
      RContent.__super__.remove.call(this);
      if ((_ref = this.sortedItems) != null) {
        _ref.remove(this);
      }
      if ((_ref1 = this.liJ) != null) {
        _ref1.remove();
      }
    };

    RContent.prototype.update = function() {};

    return RContent;

  })(RItem);

  this.RContent = RContent;

}).call(this);

//# sourceMappingURL=item.map
